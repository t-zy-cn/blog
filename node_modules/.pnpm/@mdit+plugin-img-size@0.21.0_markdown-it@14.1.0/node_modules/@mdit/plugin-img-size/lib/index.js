const b=(e,n,m)=>{let h;const c=n,d={ok:!1,pos:n,value:""};for(h=e.charAt(n);n<m&&/\d/.test(h)||h==="%";)h=e.charAt(++n);return d.ok=!0,d.pos=n,d.value=e.slice(c,n),d},M=(e,n,m)=>{if(n>=m||e.charAt(n)!=="=")return null;n++;const h=e.charAt(n);if(h!=="x"&&!/\d/.test(h))return null;const c=b(e,n,m);if(n=c.pos,e.charAt(n)!=="x")return null;n++;const d=b(e,n,m);return n=d.pos,{pos:n,width:c.value,height:d.value}},w=(e,n)=>{const m=e.env,h=e.pos,c=e.posMax;if(e.src.charAt(e.pos)!=="!"||e.src.charAt(e.pos+1)!=="[")return!1;const d=e.pos+2,f=e.md.helpers.parseLinkLabel(e,e.pos+1,!1);if(f<0)return!1;let t=f+1,r,A="",k="",g="",i="";if(t<c&&e.src.charAt(t)==="("){for(t++;t<c&&(r=e.src.charAt(t),!(r!==" "&&r!=="	"));)t++;if(t>=c)return!1;let o;o=e.md.helpers.parseLinkDestination(e.src,t,e.posMax),o.ok&&(A=e.md.normalizeLink(o.str),e.md.validateLink(A)?t=o.pos:A="");const s=t;for(;t<c&&(r=e.src.charAt(t),!(r!==" "&&r!=="	"));t++);if(o=e.md.helpers.parseLinkTitle(e.src,t,e.posMax),t<c&&s!==t&&o.ok)for(k=o.str,t=o.pos;t<c&&(r=e.src.charAt(t),!(r!==" "&&r!=="	"));t++);else k="";if(t-1>=0&&(r=e.src.charAt(t-1),r===" ")){const l=M(e.src,t,e.posMax);if(l)for({width:g,height:i,pos:t}=l;t<c&&(r=e.src.charAt(t),!(r!==" "&&r!==`
`));t++);}if(t>=c||e.src.charAt(t)!==")")return e.pos=h,!1;t++}else{let o="";if(typeof m.references>"u")return!1;for(;t<c&&(r=e.src.charAt(t),!(r!==" "&&r!=="	"));t++);if(t<c&&e.src.charAt(t)==="["){const l=t+1;t=e.md.helpers.parseLinkLabel(e,t),t>=0?o=e.src.slice(l,t++):t=f+1}else t=f+1;o||(o=e.src.slice(d,f));const s=m.references[e.md.utils.normalizeReference(o)];if(!s)return e.pos=h,!1;A=s.href,k=s.title??""}if(!n){const o=e.src.slice(d,f),s=[];e.md.inline.parse(o,e.md,e.env,s);const l=e.push("image","img",0),a=[["src",A],["alt",""]];k&&a.push(["title",k]),g&&a.push(["width",g]),i&&a.push(["height",i]),l.attrs=a,l.children=s,l.content=o}return e.pos=t,e.posMax=c,!0},R=e=>{e.inline.ruler.before("emphasis","image",w)},S=/^(.*?)\s*\|\s*(\d+)\s*x\s*(\d+)\s*$/,v=(e,n)=>{const m=e.env,h=e.pos,c=e.posMax;if(e.src.charAt(e.pos)!=="!"||e.src.charAt(e.pos+1)!=="[")return!1;const d=e.pos+2,f=e.md.helpers.parseLinkLabel(e,e.pos+1,!1);if(f<0)return!1;const t=e.src.slice(d,f),r=S.exec(t);if(!r)return!1;const[,A,k,g]=r,i=Number(k),o=Number(g);if(!i&&!o)return!1;let s=f+1,l,a="",u="";if(s<c&&e.src.charAt(s)==="("){for(s++;s<c&&(l=e.src.charAt(s),!(l!==" "&&l!=="	"));)s++;if(s>=c)return!1;let p;p=e.md.helpers.parseLinkDestination(e.src,s,e.posMax),p.ok&&(a=e.md.normalizeLink(p.str),e.md.validateLink(a)?s=p.pos:a="");const L=s;for(;s<c&&(l=e.src.charAt(s),!(l!==" "&&l!=="	"));s++);if(p=e.md.helpers.parseLinkTitle(e.src,s,e.posMax),s<c&&L!==s&&p.ok)for(u=p.str,s=p.pos;s<c&&(l=e.src.charAt(s),!(l!==" "&&l!=="	"));s++);else u="";if(s>=c||e.src.charAt(s)!==")")return e.pos=h,!1;s++}else{let p="";if(typeof m.references>"u")return!1;for(;s<c&&(l=e.src.charAt(s),!(l!==" "&&l!=="	"));s++);if(s<c&&e.src.charAt(s)==="["){const x=s+1;s=e.md.helpers.parseLinkLabel(e,s),s>=0?p=e.src.slice(x,s++):s=f+1}else s=f+1;p||(p=A);const L=m.references[e.md.utils.normalizeReference(p)];if(!L)return e.pos=h,!1;a=L.href,u=L.title??""}if(!n){const p=e.push("image","img",0),L=[["src",a],["alt",""]];u&&L.push(["title",u]),i&&L.push(["width",k]),o&&L.push(["height",g]);const x=[];e.md.inline.parse(A,e.md,e.env,x),p.attrs=L,p.children=x,p.content=A}return e.pos=s,e.posMax=c,!0},y=e=>{e.inline.ruler.before("image","obsidian-img-size",v)},I=/^(.*?)\s+=(\d*)\s*(?:x(\d*))?$/,z=(e,n)=>{const m=e.env,h=e.pos,c=e.posMax;if(e.src.charAt(e.pos)!=="!"||e.src.charAt(e.pos+1)!=="[")return!1;const d=e.pos+2,f=e.md.helpers.parseLinkLabel(e,e.pos+1,!1);if(f<0)return!1;const t=e.src.slice(d,f),r=I.exec(t);if(!r)return!1;const[,A,k,g]=r;let i=f+1,o,s="",l="";if(i<c&&e.src.charAt(i)==="("){for(i++;i<c&&(o=e.src.charAt(i),!(o!==" "&&o!=="	"));)i++;if(i>=c)return!1;let a;a=e.md.helpers.parseLinkDestination(e.src,i,e.posMax),a.ok&&(s=e.md.normalizeLink(a.str),e.md.validateLink(s)?i=a.pos:s="");const u=i;for(;i<c&&(o=e.src.charAt(i),!(o!==" "&&o!=="	"));i++);if(a=e.md.helpers.parseLinkTitle(e.src,i,e.posMax),i<c&&u!==i&&a.ok)for(l=a.str,i=a.pos;i<c&&(o=e.src.charAt(i),!(o!==" "&&o!=="	"));i++);else l="";if(i>=c||e.src.charAt(i)!==")")return e.pos=h,!1;i++}else{let a="";if(typeof m.references>"u")return!1;for(;i<c&&(o=e.src.charAt(i),!(o!==" "&&o!=="	"));i++);if(i<c&&e.src.charAt(i)==="["){const p=i+1;i=e.md.helpers.parseLinkLabel(e,i),i>=0?a=e.src.slice(p,i++):i=f+1}else i=f+1;a||(a=A);const u=m.references[e.md.utils.normalizeReference(a)];if(!u)return e.pos=h,!1;s=u.href,l=u.title??""}if(!n){const a=e.push("image","img",0),u=[["src",s],["alt",""]];l&&u.push(["title",l]),k&&u.push(["width",k]),g&&u.push(["height",g]);const p=[];e.md.inline.parse(A,e.md,e.env,p),a.attrs=u,a.children=p,a.content=A}return e.pos=i,e.posMax=c,!0},D=e=>{e.inline.ruler.before("image","img-size",z)};export{D as imgSize,z as imgSizeRule,R as legacyImgSize,y as obsidianImgSize,v as obsidianImgSizeRule};
//# sourceMappingURL=index.js.map
