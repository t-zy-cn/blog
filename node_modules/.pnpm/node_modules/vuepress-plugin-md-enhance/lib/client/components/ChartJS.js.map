{"version":3,"file":"ChartJS.js","sources":["../../../src/client/components/ChartJS.ts"],"sourcesContent":["import { LoadingIcon, decodeData, useDarkMode } from \"@vuepress/helper/client\";\nimport type { Chart, ChartConfiguration } from \"chart.js\";\nimport type { PropType, VNode } from \"vue\";\nimport {\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n  onUnmounted,\n  ref,\n  shallowRef,\n  toRefs,\n  watch,\n} from \"vue\";\nimport { onContentUpdated } from \"vuepress/client\";\n\nimport \"../styles/chartjs.scss\";\n\nconst parseChartConfig = (\n  config: string,\n  type: \"js\" | \"json\",\n): ChartConfiguration => {\n  if (type === \"json\") return JSON.parse(config) as ChartConfiguration;\n\n  // eslint-disable-next-line @typescript-eslint/no-implied-eval\n  const runner = new Function(\n    `\\\nlet config,__chart_js_config__;\n{\n${config}\n__chart_js_config__=config;\n}\nreturn __chart_js_config__;\\\n`,\n  ) as () => ChartConfiguration;\n\n  return runner();\n};\n\nexport default defineComponent({\n  name: \"ChartJS\",\n\n  props: {\n    /**\n     * Chart config\n     *\n     * 图表配置\n     */\n    config: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Chart id\n     *\n     * 图表 id\n     */\n    id: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Chart title\n     *\n     * 图表标题\n     */\n    title: String,\n\n    /**\n     * Chart config type\n     *\n     * 图表配置类型\n     */\n    type: {\n      type: String as PropType<\"js\" | \"json\">,\n      default: \"json\",\n    },\n  },\n\n  setup(props) {\n    const { config, id } = toRefs(props);\n    const isDarkMode = useDarkMode();\n    const chartElement = shallowRef<HTMLElement>();\n    const chartCanvasElement = shallowRef<HTMLCanvasElement>();\n\n    const loaded = ref(false);\n\n    let chartjs: Chart | null;\n\n    const destroyChart = (): void => {\n      chartjs?.destroy();\n      chartjs = null;\n    };\n\n    const renderChart = async (): Promise<void> => {\n      if (__VUEPRESS_SSR__) return;\n\n      const { default: ChartJs } = await import(\n        /* webpackChunkName: \"chart\" */ \"chart.js/auto\"\n      );\n\n      ChartJs.defaults.borderColor = isDarkMode.value ? \"#ccc\" : \"#36A2EB\";\n      ChartJs.defaults.color = isDarkMode.value ? \"#fff\" : \"#000\";\n      ChartJs.defaults.maintainAspectRatio = false;\n\n      const chartConfig = decodeData(props.config);\n      const data = parseChartConfig(chartConfig, props.type);\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const ctx = chartCanvasElement.value!.getContext(\"2d\")!;\n\n      chartjs = new ChartJs(ctx, data);\n    };\n\n    onContentUpdated(async (reason) => {\n      if (reason === \"mounted\") {\n        await renderChart();\n        loaded.value = true;\n      }\n    });\n\n    onMounted(() => {\n      watch(\n        __VUEPRESS_DEV__\n          ? // config must be changed if type is changed, so no need to watch type\n            [config, id, isDarkMode]\n          : isDarkMode,\n        async () => {\n          destroyChart();\n          await nextTick();\n          await renderChart();\n        },\n        { flush: \"post\" },\n      );\n    });\n\n    onUnmounted(destroyChart);\n\n    return (): (VNode | null)[] => [\n      props.title\n        ? h(\"div\", { class: \"chartjs-title\" }, decodeURIComponent(props.title))\n        : null,\n      loaded.value\n        ? null\n        : h(LoadingIcon, { class: \"chartjs-loading\", height: 192 }),\n      h(\n        \"div\",\n        {\n          ref: chartElement,\n          class: \"chartjs-wrapper\",\n          id: props.id,\n          style: {\n            display: loaded.value ? \"block\" : \"none\",\n          },\n        },\n        h(\"canvas\", {\n          ref: chartCanvasElement,\n          height: 400,\n        }),\n      ),\n    ];\n  },\n});\n"],"names":["parseChartConfig","config","type","defineComponent","props","id","toRefs","isDarkMode","useDarkMode","chartElement","shallowRef","chartCanvasElement","loaded","ref","chartjs","destroyChart","renderChart","ChartJs","chartConfig","decodeData","data","ctx","onContentUpdated","reason","onMounted","watch","nextTick","onUnmounted","h","LoadingIcon"],"mappings":"oTAkBA,MAAMA,EAAmB,CACvBC,EACAC,IAEIA,IAAS,OAAe,KAAK,MAAMD,CAAM,EAG9B,IAAI,SACjB;AAAA;AAAA,EAGFA,CAAM;AAAA;AAAA;AAAA,4BAKN,EAKF,EAAA,MAAeE,EAAgB,CAC7B,KAAM,UAEN,MAAO,CAML,OAAQ,CACN,KAAM,OACN,SAAU,EACZ,EAOA,GAAI,CACF,KAAM,OACN,SAAU,EACZ,EAOA,MAAO,OAOP,KAAM,CACJ,KAAM,OACN,QAAS,MACX,CACF,EAEA,MAAMC,EAAO,CACX,KAAM,CAAE,OAAAH,EAAQ,GAAAI,CAAG,EAAIC,EAAOF,CAAK,EAC7BG,EAAaC,EAAY,EACzBC,EAAeC,IACfC,EAAqBD,EAA8B,EAEnDE,EAASC,EAAI,EAAK,EAExB,IAAIC,EAEJ,MAAMC,EAAe,IAAY,CAC/BD,GAAS,UACTA,EAAU,IACZ,EAEME,EAAc,SAA2B,CAC7C,GAAI,iBAAkB,OAEtB,KAAM,CAAE,QAASC,CAAQ,EAAI,KACK,QAAA,eAClC,EAEAA,EAAQ,SAAS,YAAcV,EAAW,MAAQ,OAAS,UAC3DU,EAAQ,SAAS,MAAQV,EAAW,MAAQ,OAAS,OACrDU,EAAQ,SAAS,oBAAsB,GAEvC,MAAMC,EAAcC,EAAWf,EAAM,MAAM,EACrCgB,EAAOpB,EAAiBkB,EAAad,EAAM,IAAI,EAE/CiB,EAAMV,EAAmB,MAAO,WAAW,IAAI,EAErDG,EAAU,IAAIG,EAAQI,EAAKD,CAAI,CACjC,EAEA,OAAAE,EAAiB,MAAOC,GAAW,CAC7BA,IAAW,YACb,MAAMP,EAAY,EAClBJ,EAAO,MAAQ,GAEnB,CAAC,EAEDY,EAAU,IAAM,CACdC,EACE,iBAEI,CAACxB,EAAQI,EAAIE,CAAU,EACvBA,EACJ,SAAY,CACVQ,IACA,MAAMW,EAAS,EACf,MAAMV,EAAY,CACpB,EACA,CAAE,MAAO,MAAO,CAClB,CACF,CAAC,EAEDW,EAAYZ,CAAY,EAEjB,IAAwB,CAC7BX,EAAM,MACFwB,EAAE,MAAO,CAAE,MAAO,eAAgB,EAAG,mBAAmBxB,EAAM,KAAK,CAAC,EACpE,KACJQ,EAAO,MACH,KACAgB,EAAEC,EAAa,CAAE,MAAO,kBAAmB,OAAQ,GAAI,CAAC,EAC5DD,EACE,MACA,CACE,IAAKnB,EACL,MAAO,kBACP,GAAIL,EAAM,GACV,MAAO,CACL,QAASQ,EAAO,MAAQ,QAAU,MACpC,CACF,EACAgB,EAAE,SAAU,CACV,IAAKjB,EACL,OAAQ,GACV,CAAC,CACH,CACF,CACF,CACF,CAAC"}