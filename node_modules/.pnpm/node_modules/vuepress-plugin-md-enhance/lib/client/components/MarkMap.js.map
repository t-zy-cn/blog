{"version":3,"file":"MarkMap.js","sources":["../../../src/client/components/MarkMap.ts"],"sourcesContent":["import { LoadingIcon, decodeData } from \"@vuepress/helper/client\";\nimport { useDebounceFn, useEventListener } from \"@vueuse/core\";\nimport type { Markmap } from \"markmap-view\";\nimport type { VNode } from \"vue\";\nimport {\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n  onUnmounted,\n  ref,\n  shallowRef,\n  toRefs,\n  watch,\n} from \"vue\";\nimport { onContentUpdated } from \"vuepress/client\";\n\nimport \"../styles/markmap.scss\";\n\nexport default defineComponent({\n  name: \"MarkMap\",\n\n  props: {\n    /**\n     * Chart id\n     *\n     * 图表 id\n     */\n    id: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Markmap content\n     *\n     * Markmap\n     */\n    content: {\n      type: String,\n      required: true,\n    },\n  },\n\n  setup(props) {\n    const { content, id } = toRefs(props);\n    const markupWrapper = shallowRef<HTMLElement>();\n    const markmapSVG = shallowRef<SVGElement>();\n\n    const loaded = ref(false);\n\n    let markmap: Markmap | null = null;\n\n    useEventListener(\n      \"resize\",\n      useDebounceFn(() => {\n        void markmap?.fit();\n      }, 100),\n    );\n\n    const destroyMarkmap = (): void => {\n      markmap?.destroy();\n      markmap = null;\n    };\n\n    const renderMarkmap = async (): Promise<void> => {\n      if (__VUEPRESS_SSR__) return;\n\n      const [{ Transformer }, { Markmap, deriveOptions }, { Toolbar }] =\n        await Promise.all([\n          import(/* webpackChunkName: \"markmap\" */ \"markmap-lib\"),\n          import(/* webpackChunkName: \"markmap\" */ \"markmap-view\"),\n          import(/* webpackChunkName: \"markmap\" */ \"markmap-toolbar\"),\n        ]);\n\n      const transformer = new Transformer();\n      const { frontmatter, root } = transformer.transform(\n        decodeData(props.content),\n      );\n\n      markmap = Markmap.create(\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n        markmapSVG.value!,\n        deriveOptions({\n          maxWidth: 240,\n          ...frontmatter?.markmap,\n        }),\n      );\n\n      const { el } = Toolbar.create(markmap);\n\n      await markmap.setData(root);\n      await markmap.fit();\n\n      el.style.position = \"absolute\";\n      el.style.bottom = \"0.5rem\";\n      el.style.right = \"0.5rem\";\n\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      markupWrapper.value!.append(el);\n    };\n\n    onContentUpdated(async (reason) => {\n      if (reason === \"mounted\") {\n        await renderMarkmap();\n        loaded.value = true;\n      }\n    });\n\n    onMounted(() => {\n      if (!__VUEPRESS_DEV__) return;\n\n      // config must be changed if type is changed, so no need to watch it\n      watch(\n        [content, id],\n        async () => {\n          destroyMarkmap();\n          await nextTick();\n          await renderMarkmap();\n        },\n        { flush: \"post\" },\n      );\n    });\n\n    onUnmounted(destroyMarkmap);\n\n    return (): VNode =>\n      h(\"div\", { class: \"markmap-wrapper\", ref: markupWrapper }, [\n        h(\"svg\", {\n          ref: markmapSVG,\n          class: \"markmap-svg\",\n          id: props.id,\n        }),\n        loaded.value\n          ? null\n          : h(LoadingIcon, { class: \"markmap-loading\", height: 360 }),\n      ]);\n  },\n});\n"],"names":["defineComponent","props","content","id","toRefs","markupWrapper","shallowRef","markmapSVG","loaded","ref","markmap","useEventListener","useDebounceFn","destroyMarkmap","renderMarkmap","Transformer","Markmap","deriveOptions","Toolbar","transformer","frontmatter","root","decodeData","el","onContentUpdated","reason","onMounted","watch","nextTick","onUnmounted","h","LoadingIcon"],"mappings":"sWAmBA,IAAeA,EAAAA,EAAgB,CAC7B,KAAM,UAEN,MAAO,CAML,GAAI,CACF,KAAM,OACN,SAAU,EACZ,EAOA,QAAS,CACP,KAAM,OACN,SAAU,EACZ,CACF,EAEA,MAAMC,EAAO,CACX,KAAM,CAAE,QAAAC,EAAS,GAAAC,CAAG,EAAIC,EAAOH,CAAK,EAC9BI,EAAgBC,EAChBC,EAAAA,EAAaD,IAEbE,EAASC,EAAI,EAAK,EAExB,IAAIC,EAA0B,KAE9BC,EACE,SACAC,EAAc,IAAM,CACbF,GAAS,IAAA,CAChB,EAAG,GAAG,CACR,EAEA,MAAMG,EAAiB,IAAY,CACjCH,GAAS,QAAQ,EACjBA,EAAU,IACZ,EAEMI,EAAgB,SAA2B,CAC/C,GAAI,iBAAkB,OAEtB,KAAM,CAAC,CAAE,YAAAC,CAAY,EAAG,CAAE,QAAAC,EAAS,cAAAC,CAAc,EAAG,CAAE,QAAAC,CAAQ,CAAC,EAC7D,MAAM,QAAQ,IAAI,CAChB,OAAyC,aAAa,EACtD,OAAyC,cAAc,EACvD,OAAyC,iBAAiB,CAC5D,CAAC,EAEGC,EAAc,IAAIJ,EAClB,CAAE,YAAAK,EAAa,KAAAC,CAAK,EAAIF,EAAY,UACxCG,EAAWrB,EAAM,OAAO,CAC1B,EAEAS,EAAUM,EAAQ,OAEhBT,EAAW,MACXU,EAAc,CACZ,SAAU,IACV,GAAGG,GAAa,OAClB,CAAC,CACH,EAEA,KAAM,CAAE,GAAAG,CAAG,EAAIL,EAAQ,OAAOR,CAAO,EAErC,MAAMA,EAAQ,QAAQW,CAAI,EAC1B,MAAMX,EAAQ,IAAA,EAEda,EAAG,MAAM,SAAW,WACpBA,EAAG,MAAM,OAAS,SAClBA,EAAG,MAAM,MAAQ,SAGjBlB,EAAc,MAAO,OAAOkB,CAAE,CAChC,EAEA,OAAAC,EAAiB,MAAOC,GAAW,CAC7BA,IAAW,YACb,MAAMX,IACNN,EAAO,MAAQ,GAEnB,CAAC,EAEDkB,EAAU,IAAM,CACT,kBAGLC,EACE,CAACzB,EAASC,CAAE,EACZ,SAAY,CACVU,IACA,MAAMe,EAAS,EACf,MAAMd,EACR,CAAA,EACA,CAAE,MAAO,MAAO,CAClB,CACF,CAAC,EAEDe,EAAYhB,CAAc,EAEnB,IACLiB,EAAE,MAAO,CAAE,MAAO,kBAAmB,IAAKzB,CAAc,EAAG,CACzDyB,EAAE,MAAO,CACP,IAAKvB,EACL,MAAO,cACP,GAAIN,EAAM,EACZ,CAAC,EACDO,EAAO,MACH,KACAsB,EAAEC,EAAa,CAAE,MAAO,kBAAmB,OAAQ,GAAI,CAAC,CAC9D,CAAC,CACL,CACF,CAAC"}